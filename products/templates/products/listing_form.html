{% extends "base.html" %}
{% load static %} {# Đảm bảo đã load static #}

{% block title %}{{ form_title }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto bg-gray-50 p-6 rounded-lg shadow-md border border-gray-200"> {# Thay đổi max-width và background #}
    <h1 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-3">{{ form_title }}</h1>

    {# --- Bắt đầu form --- #}
        <form method="post" enctype="multipart/form-data" class="space-y-8"> {# Thêm space-y để tạo khoảng cách giữa các khối #}
            {% csrf_token %}

        {# --- Khối Thông tin cơ bản (Ví dụ fieldset) --- #}
        <fieldset class="border rounded-md p-4 bg-white shadow-sm">
            <legend class="text-lg font-semibold mb-4 px-2 text-gray-700">Thông tin cơ bản</legend>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                {# Render từng field thủ công để kiểm soát layout #}
                <div class="md:col-span-2"> {# Tiêu đề chiếm cả hàng #}
                    <label for="{{ form.tieu_de.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.tieu_de.label }}</label>
                    {{ form.tieu_de }}
                    {% if form.tieu_de.help_text %}<p class="text-xs text-gray-500 mt-1">{{ form.tieu_de.help_text }}</p>{% endif %}
                    {% if form.tieu_de.errors %}<p class="text-red-500 text-xs mt-1">{{ form.tieu_de.errors|striptags }}</p>{% endif %}
                </div>

                <div>
                    <label for="{{ form.gia.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.gia.label }} (VNĐ)</label>
                    {{ form.gia }}
                    {% if form.gia.errors %}<p class="text-red-500 text-xs mt-1">{{ form.gia.errors|striptags }}</p>{% endif %}
                </div>
                <div>
                    <label for="{{ form.dien_tich.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.dien_tich.label }} (m²)</label>
                    {{ form.dien_tich }}
                    {% if form.dien_tich.errors %}<p class="text-red-500 text-xs mt-1">{{ form.dien_tich.errors|striptags }}</p>{% endif %}
                </div>
                 <div>
                    <label for="{{ form.phap_ly.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.phap_ly.label }}</label>
                    {{ form.phap_ly }}
                    {% if form.phap_ly.errors %}<p class="text-red-500 text-xs mt-1">{{ form.phap_ly.errors|striptags }}</p>{% endif %}
                </div>
                 <div>
                    <label for="{{ form.huong.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.huong.label }}</label>
                    {{ form.huong }}
                    {% if form.huong.errors %}<p class="text-red-500 text-xs mt-1">{{ form.huong.errors|striptags }}</p>{% endif %}
                </div>
                 <div>
                    <label for="{{ form.mat_tien.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.mat_tien.label }} (m)</label>
                    {{ form.mat_tien }}
                    {% if form.mat_tien.errors %}<p class="text-red-500 text-xs mt-1">{{ form.mat_tien.errors|striptags }}</p>{% endif %}
                </div>
                <div>
                    <label for="{{ form.chieu_dai.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.chieu_dai.label }} (m)</label>
                    {{ form.chieu_dai }}
                    {% if form.chieu_dai.errors %}<p class="text-red-500 text-xs mt-1">{{ form.chieu_dai.errors|striptags }}</p>{% endif %}
                </div>
                 <div class="md:col-span-2">
                    <label for="{{ form.loai_dat.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.loai_dat.label }}</label>
                    {{ form.loai_dat }}
                    {% if form.loai_dat.errors %}<p class="text-red-500 text-xs mt-1">{{ form.loai_dat.errors|striptags }}</p>{% endif %}
                </div>

                {# Ảnh đại diện #}
                 <div class="md:col-span-2">
                     <label for="{{ form.anh_dai_dien.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.anh_dai_dien.label }}</label>
                     {# Hiển thị ảnh cũ nếu đang sửa #}
                     {% if product and product.anh_dai_dien %}
                     <div class="mb-2">
                         <img src="{{ product.anh_dai_dien.url }}" alt="Ảnh đại diện hiện tại" class="h-24 w-auto rounded border">
                         <span class="text-xs text-gray-500 ml-2">Ảnh hiện tại. Chọn ảnh mới để thay thế.</span>
                     </div>
                     {% endif %}
                     {{ form.anh_dai_dien }}
                     {% if form.anh_dai_dien.errors %}<p class="text-red-500 text-xs mt-1">{{ form.anh_dai_dien.errors|striptags }}</p>{% endif %}
                 </div>

                {# Mô tả chiếm cả hàng #}
                <div class="md:col-span-2">
                    <label for="{{ form.mo_ta.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.mo_ta.label }}</label>
                    {{ form.mo_ta }}
                    {% if form.mo_ta.errors %}<p class="text-red-500 text-xs mt-1">{{ form.mo_ta.errors|striptags }}</p>{% endif %}
                </div>
            </div>
        </fieldset>
        {# --- Hết khối Thông tin cơ bản --- #}


        {# --- Khối Thông tin vị trí --- #}
         <fieldset class="border rounded-md p-4 bg-white shadow-sm">
            <legend class="text-lg font-semibold mb-4 px-2 text-gray-700">Thông tin vị trí</legend>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                 <div class="md:col-span-2">
                    <label for="{{ form.dia_chi.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.dia_chi.label }}</label>
                    {{ form.dia_chi }}
                    {% if form.dia_chi.errors %}<p class="text-red-500 text-xs mt-1">{{ form.dia_chi.errors|striptags }}</p>{% endif %}
                </div>
                 <div>
                    <label for="{{ form.tinh_thanh.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.tinh_thanh.label }}</label>
                    {{ form.tinh_thanh }}
                    {% if form.tinh_thanh.errors %}<p class="text-red-500 text-xs mt-1">{{ form.tinh_thanh.errors|striptags }}</p>{% endif %}
                </div>
                <div>
                    <label for="{{ form.quan_huyen.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.quan_huyen.label }}</label>
                    {{ form.quan_huyen }}
                    {% if form.quan_huyen.errors %}<p class="text-red-500 text-xs mt-1">{{ form.quan_huyen.errors|striptags }}</p>{% endif %}
                </div>
                <div>
                    <label for="{{ form.phuong_xa.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.phuong_xa.label }}</label>
                    {{ form.phuong_xa }}
                    {% if form.phuong_xa.errors %}<p class="text-red-500 text-xs mt-1">{{ form.phuong_xa.errors|striptags }}</p>{% endif %}
                </div>
                {# Tọa độ (ẩn hoặc hiện tùy ý) #}
                 {# <div>
                    <label for="{{ form.vi_do.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.vi_do.label }}</label>
                    {{ form.vi_do }}
                    {% if form.vi_do.errors %}<p class="text-red-500 text-xs mt-1">{{ form.vi_do.errors|striptags }}</p>{% endif %}
                </div>
                 <div>
                    <label for="{{ form.kinh_do.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.kinh_do.label }}</label>
                    {{ form.kinh_do }}
                    {% if form.kinh_do.errors %}<p class="text-red-500 text-xs mt-1">{{ form.kinh_do.errors|striptags }}</p>{% endif %}
                </div> #}
            </div>
         </fieldset>
        {# --- Hết khối Thông tin vị trí --- #}

        <fieldset class="border rounded-md p-4 bg-white shadow-sm">
            <legend class="text-lg font-semibold mb-4 px-2 text-gray-700">Thông tin liên hệ</legend>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                 <div class="md:col-span-2"> {# Tên người bán chiếm cả hàng #}
                    <label for="{{ form.ten_nguoi_ban.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.ten_nguoi_ban.label }}</label>
                    {{ form.ten_nguoi_ban }}
                    {% if form.ten_nguoi_ban.errors %}<p class="text-red-500 text-xs mt-1">{{ form.ten_nguoi_ban.errors|striptags }}</p>{% endif %}
                </div>
                 <div>
                    <label for="{{ form.so_dien_thoai.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.so_dien_thoai.label }}</label>
                    {{ form.so_dien_thoai }}
                    {% if form.so_dien_thoai.errors %}<p class="text-red-500 text-xs mt-1">{{ form.so_dien_thoai.errors|striptags }}</p>{% endif %}
                </div>
                <div>
                    <label for="{{ form.email.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.email.label }}</label>
                    {{ form.email }}
                    {% if form.email.errors %}<p class="text-red-500 text-xs mt-1">{{ form.email.errors|striptags }}</p>{% endif %}
                </div>
            </div>
        </fieldset>


        {# --- Khối Ảnh chi tiết (Formset) --- #}
        <fieldset class="border rounded-md p-4 bg-white shadow-sm">
            <legend class="text-lg font-semibold mb-4 px-2 text-gray-700">Ảnh chi tiết</legend>
            {{ formset.management_form }} {# Vẫn cần Management Form #}

            {# Container cho các form ảnh #}
            <div id="image-formset-container" class="space-y-4">
                {% for image_form in formset %}
                    {# --- Bọc mỗi form trong một div với class ví dụ 'image-form-row' --- #}
                    <div class="image-form-row border rounded p-3 {% if image_form.instance.pk %}bg-gray-50{% else %}bg-blue-50{% endif %} relative">
                        {% for hidden in image_form.hidden_fields %}
                            {{ hidden }}
                        {% endfor %}
                        
                        {% if image_form.instance.pk and image_form.instance.image %}
                            <img src="{{ image_form.instance.image.url }}" alt="Ảnh chi tiết" class="h-20 w-20 ...">
                        {% endif %}
                        <div class="inline-block align-top space-y-2" style="width: calc(100% - 100px);">
                             <div>
                                <label ...>{{ image_form.image.label }}</label>
                                {{ image_form.image }}
                             </div>
                            <div>
                                <label ...>{{ image_form.alt_text.label }}</label>
                                {{ image_form.alt_text }}
                            </div>
                        </div>
                        {% if image_form.instance.pk %}
                            <div class="absolute top-2 right-2">
                                <label ...>{{ image_form.DELETE }} Xóa</label>
                            </div>
                        {% endif %}
                         {% if image_form.errors %}
                             <div class="text-red-500 ..."> ... </div>
                         {% endif %}
                    </div>
                 {% endfor %}
             </div>

             {# --- Nút để thêm form mới --- #}
             <button type="button" id="add-image-form-button" class="mt-3 text-sm bg-green-100 text-green-700 px-3 py-1 rounded hover:bg-green-200">
                 + Thêm ảnh khác
             </button>

             {# --- Template ẩn cho form mới (quan trọng) --- #}
             <div class="hidden" id="empty-image-form-template">
                 {# Render empty_form vào đây, bọc trong cùng cấu trúc div như trên #}
                 <div class="image-form-row border rounded p-3 bg-blue-50 relative">
                      <div class="inline-block align-top space-y-2" style="width: calc(100% - 100px);">
                         <div>
                            <label for="{{ formset.empty_form.image.id_for_label }}" class="block ...">{{ formset.empty_form.image.label }}</label>
                            {{ formset.empty_form.image }}
                         </div>
                        <div>
                            <label for="{{ formset.empty_form.alt_text.id_for_label }}" class="block ...">{{ formset.empty_form.alt_text.label }}</label>
                            {{ formset.empty_form.alt_text }}
                        </div>
                    </div>
                    {# Không có nút xóa cho empty form #}
                 </div>
             </div>

         </fieldset>
        {# --- Hết khối Ảnh chi tiết --- #}


        {# --- Nút Submit --- #}
        <div class="mt-8 text-right"> {# Đẩy nút về bên phải #}
            <button type="submit" class="bg-indigo-600 text-white py-2 px-6 rounded-md font-semibold hover:bg-indigo-700 transition duration-200">
                {% if product %}Lưu thay đổi{% else %}Đăng tin{% endif %}
            </button>
        </div>
        {# --- Hết Nút Submit --- #}

    </form>
    {# --- Hết form --- #}
</div>

{# --- CSS cơ bản cho input (Thêm vào <head> hoặc file CSS riêng nếu cần) --- #}
{# Đảm bảo các input của bạn có class phù hợp từ Tailwind hoặc CSS tùy chỉnh #}
<style>
    /* Áp dụng style cơ bản cho các input, select, textarea trong form này */
    form input[type='text'],
    form input[type='number'],
    form input[type='email'],
    form input[type='url'],
    form input[type='password'],
    form input[type='search'],
    form input[type='tel'],
    form input[type='date'],
    form input[type='datetime-local'],
    form input[type='month'],
    form input[type='time'],
    form input[type='week'],
    form select,
    form textarea {
        @apply block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm;
    }
    form input[type='checkbox'],
    form input[type='radio'] {
         @apply rounded border-gray-300 text-indigo-600 focus:ring-indigo-500;
    }
    form input[type='file'] {
         @apply block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100;
    }

</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'js/jquery.formset.js' %}"></script>
<script type="text/javascript">
    $(function() {
        $('#image-formset-container .image-form-row').formset({
            prefix: '{{ formset.prefix }}', // Lấy prefix từ context ('images')
            addText: '+ Thêm ảnh nữa',      // Thay đổi text nút thêm (plugin tự tạo hoặc dùng nút của bạn)
            deleteText: 'Xóa ảnh này',    // Thay đổi text nút xóa (plugin tự tạo hoặc dùng nút của bạn)
            addCssClass: 'add-image-form-button', // Class cho nút thêm plugin tự tạo (nếu dùng)
            deleteCssClass: 'delete-image-form-button', // Class cho nút xóa plugin tự tạo
            emptyCssClass: 'empty-form', // Class để xác định form rỗng (ít dùng)
            added: function(row) {
                // Callback sau khi thêm form (tùy chọn)
                console.log('Form mới đã được thêm');
                // Có thể thêm logic JS khác ở đây, ví dụ: preview ảnh mới tải lên
            },
            removed: function(row) {
                // Callback sau khi xóa form (tùy chọn)
                console.log('Form đã được xóa');
            }
            // --- Nếu bạn muốn dùng nút "Thêm" tùy chỉnh của mình ---
            // addButton: "#add-image-form-button", // Selector của nút thêm bạn đã tạo
            // --- Nếu dùng template tùy chỉnh ---
            // formTemplate: "#empty-image-form-template", // Selector của template ẩn
        });
    })
</script>

{% endblock %}